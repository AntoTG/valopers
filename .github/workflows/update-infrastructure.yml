name: Update Infrastructure Data

on:
  schedule:
    - cron: "0 * * * *"  # Runs every hour
  workflow_dispatch:      # Allows manual triggering

jobs:
  update-infrastructure:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # Explicitly set permissions for repo operations
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4    # Updated to latest version
        
      - name: Clone Luminara-Hub repository
        run: git clone --depth 1 https://github.com/Luminara-Hub/namada-ecosystem.git external-repo

      - name: Set up Python
        uses: actions/setup-python@v5    # Updated to latest version
        with:
          python-version: '3.12'         # Using stable Python version
          cache: 'pip'                   # Enable pip caching

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run update_data script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python namada/update_data.py

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add namada/infrastructure.json
          timestamp=$(date -u)
          git commit -m "chore: update infrastructure data [skip ci] ${timestamp}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
